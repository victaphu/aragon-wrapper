{"version":3,"sources":["../../../src/rpc/handlers/external.test.js"],"names":["test","beforeEach","t","configurationStub","getConfiguration","sinon","stub","utilsStub","events","eventsUtils","external","context","afterEach","always","restore","targetAddr","targetMethodAbiFragment","name","targetParams","mockPath","to","data","plan","wrapperStub","getExternalTransactionPath","returns","performTransactionPath","Promise","resolve","requestStub","params","result","intent","notThrowsAsync","true","calledOnceWith","eventEmitter","EventEmitter","proxy","eventsStub","contract","allEvents","web3Stub","eth","Contract","fromBlock","web3","subscribe","value","deepEqual","event","amount","emit","initBlock","initializationBlock","getPastEvents","withArgs","pastEvents","toBlock","configurationKeys","SUBSCRIPTION_EVENT_DELAY","startTime","Date","now","delayTime"],"mappings":"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","sourcesContent":["import test from 'ava'\nimport proxyquire from 'proxyquire'\nimport sinon from 'sinon'\nimport { EventEmitter } from 'events'\n\nimport * as configurationKeys from '../../configuration/keys'\nimport * as eventsUtils from '../../utils/events'\n\ntest.beforeEach(t => {\n  const configurationStub = {\n    getConfiguration: sinon.stub()\n  }\n  const utilsStub = {\n    events: eventsUtils\n  }\n  const external = proxyquire('./external', {\n    '../../configuration': configurationStub,\n    '../../utils': utilsStub\n  })\n\n  t.context = {\n    external,\n    configurationStub,\n    utilsStub\n  }\n})\n\ntest.afterEach.always(() => {\n  sinon.restore()\n})\n\ntest('should return the correct tx path from external tx intent', async t => {\n  const { external } = t.context\n  const targetAddr = '0x123'\n  const targetMethodAbiFragment = [{ name: 'foo' }]\n  const targetParams = [8]\n  const mockPath = [{ to: '0x123', data: '0x456' }]\n\n  t.plan(3)\n  // arrange\n  const wrapperStub = {\n    getExternalTransactionPath: sinon.stub().returns(mockPath),\n    performTransactionPath: sinon.stub().returns(Promise.resolve())\n  }\n  const requestStub = {\n    params: [targetAddr, targetMethodAbiFragment, ...targetParams]\n  }\n  // act\n  const result = external.intent(requestStub, null, wrapperStub)\n  // assert\n  await t.notThrowsAsync(result)\n  t.true(wrapperStub.getExternalTransactionPath.calledOnceWith(targetAddr, targetMethodAbiFragment, targetParams))\n  t.true(wrapperStub.performTransactionPath.calledOnceWith(mockPath, { external: true }))\n})\n\ntest('should return an observable from the contract events', async (t) => {\n  const { external } = t.context\n\n  t.plan(2)\n  // arrange\n  const eventEmitter = new EventEmitter()\n  const proxy = {}\n  const eventsStub = sinon.stub().returns(eventEmitter)\n  const contract = {\n    events: {\n      allEvents: eventsStub\n    }\n  }\n  const web3Stub = {\n    eth: {\n      Contract: sinon.stub().returns(contract)\n    }\n  }\n  const requestStub = {\n    params: ['addr', 'ji', 'allEvents', { fromBlock: 8 }]\n  }\n  // act\n  const events = external.events(requestStub, proxy, { web3: web3Stub })\n  // assert\n  t.true(eventsStub.calledOnceWith({ fromBlock: 8 }))\n  events.subscribe(value => {\n    t.deepEqual(value, { event: 'pay_fee', amount: 5 })\n  })\n\n  eventEmitter.emit('data', { event: 'pay_fee', amount: 5 })\n})\n\ntest(\"should default fetching contract events from app's initialization block\", async (t) => {\n  const { external } = t.context\n  const initBlock = 10\n\n  t.plan(2)\n  // arrange\n  const eventEmitter = new EventEmitter()\n  const proxy = { initializationBlock: initBlock }\n  const eventsStub = sinon.stub().returns(eventEmitter)\n  const contract = {\n    events: {\n      allEvents: eventsStub\n    }\n  }\n  const web3Stub = {\n    eth: {\n      Contract: sinon.stub().returns(contract)\n    }\n  }\n  const requestStub = {\n    params: ['addr', 'ji', 'allEvents', {}]\n  }\n  // act\n  const events = external.events(requestStub, proxy, { web3: web3Stub })\n  // assert\n  t.true(eventsStub.calledOnceWith({ fromBlock: initBlock }))\n  events.subscribe(value => {\n    t.deepEqual(value, { event: 'pay_fee', amount: 5 })\n  })\n\n  eventEmitter.emit('data', { event: 'pay_fee', amount: 5 })\n})\n\ntest('should handle events for aragonAPIv1', async (t) => {\n  const { external } = t.context\n  const fromBlock = 10\n\n  t.plan(2)\n  // arrange\n  const eventEmitter = new EventEmitter()\n  const proxy = {}\n  const eventsStub = sinon.stub().returns(eventEmitter)\n  const contract = {\n    events: {\n      allEvents: eventsStub\n    }\n  }\n  const web3Stub = {\n    eth: {\n      Contract: sinon.stub().returns(contract)\n    }\n  }\n  // aragonAPIv1 only passes the fromBlock\n  const requestStub = {\n    params: ['addr', 'ji', fromBlock]\n  }\n  // act\n  const events = external.events(requestStub, proxy, { web3: web3Stub })\n  // assert\n  t.true(eventsStub.calledOnceWith({ fromBlock }))\n  events.subscribe(value => {\n    t.deepEqual(value, { event: 'pay_fee', amount: 5 })\n  })\n\n  eventEmitter.emit('data', { event: 'pay_fee', amount: 5 })\n})\n\ntest('should handle events without fromBlock for aragonAPIv1', async (t) => {\n  const { external } = t.context\n  const initBlock = 10\n\n  t.plan(2)\n  // arrange\n  const eventEmitter = new EventEmitter()\n  const proxy = { initializationBlock: initBlock }\n  const eventsStub = sinon.stub().returns(eventEmitter)\n  const contract = {\n    events: {\n      allEvents: eventsStub\n    }\n  }\n  const web3Stub = {\n    eth: {\n      Contract: sinon.stub().returns(contract)\n    }\n  }\n  // aragonAPIv1 does not need to pass the fromBlock\n  const requestStub = {\n    params: ['addr', 'ji']\n  }\n  // act\n  const events = external.events(requestStub, proxy, { web3: web3Stub })\n  // assert\n  t.true(eventsStub.calledOnceWith({ fromBlock: initBlock }))\n  events.subscribe(value => {\n    t.deepEqual(value, { event: 'pay_fee', amount: 5 })\n  })\n\n  eventEmitter.emit('data', { event: 'pay_fee', amount: 5 })\n})\n\ntest(\"should return an observable from the contract's past events\", async (t) => {\n  const { external } = t.context\n\n  t.plan(2)\n  // arrange\n  const proxy = {}\n  const contract = {\n    getPastEvents: sinon.stub().returns([{ event: 'pay_fee', amount: 5 }])\n  }\n  const web3Stub = {\n    eth: {\n      Contract: sinon.stub().withArgs('addr', 'ji').returns(contract)\n    }\n  }\n  const requestStub = {\n    params: ['addr', 'ji', 'allEvents', { fromBlock: 8 }]\n  }\n  // act\n  const result = external.pastEvents(requestStub, proxy, { web3: web3Stub })\n  // assert\n  t.true(contract.getPastEvents.calledOnceWith('allEvents', { fromBlock: 8 }))\n  result.subscribe(value => {\n    t.deepEqual(value, { event: 'pay_fee', amount: 5 })\n  })\n})\n\ntest(\"should default fetching past events starting from app's initialization block\", async (t) => {\n  const { external } = t.context\n  const initBlock = 10\n\n  t.plan(2)\n  // arrange\n  const proxy = { initializationBlock: initBlock }\n  const contract = {\n    getPastEvents: sinon.stub().returns([{ event: 'pay_fee', amount: 5 }])\n  }\n  const web3Stub = {\n    eth: {\n      Contract: sinon.stub().withArgs('addr', 'ji').returns(contract)\n    }\n  }\n  const requestStub = {\n    params: ['addr', 'ji', 'allEvents', {}]\n  }\n  // act\n  const result = external.pastEvents(requestStub, proxy, { web3: web3Stub })\n  // assert\n  t.true(contract.getPastEvents.calledOnceWith('allEvents', { fromBlock: initBlock }))\n  result.subscribe(value => {\n    t.deepEqual(value, { event: 'pay_fee', amount: 5 })\n  })\n})\n\ntest('should handle past events for aragonAPIv1', async (t) => {\n  const { external } = t.context\n  const initBlock = 10\n  const toBlock = 18\n\n  t.plan(2)\n  // arrange\n  const proxy = { initializationBlock: initBlock }\n  const contract = {\n    getPastEvents: sinon.stub().returns([{ event: 'pay_fee', amount: 5 }])\n  }\n  const web3Stub = {\n    eth: {\n      Contract: sinon.stub().withArgs('addr', 'ji').returns(contract)\n    }\n  }\n  // aragonAPIv1 only passes the event options\n  const requestStub = {\n    params: ['addr', 'ji', { toBlock }]\n  }\n  // act\n  const result = external.pastEvents(requestStub, proxy, { web3: web3Stub })\n  // assert\n  t.true(contract.getPastEvents.calledOnceWith('allEvents', { fromBlock: initBlock, toBlock }))\n  result.subscribe(value => {\n    t.deepEqual(value, { event: 'pay_fee', amount: 5 })\n  })\n})\n\ntest('should not apply a delay to events if not configured', async (t) => {\n  const { external, configurationStub } = t.context\n\n  t.plan(2)\n  // arrange\n  const eventEmitter = new EventEmitter()\n  const proxy = {}\n  const contract = {\n    events: {\n      'allEvents': sinon.stub().returns(eventEmitter)\n    }\n  }\n  const web3Stub = {\n    eth: {\n      Contract: sinon.stub().returns(contract)\n    }\n  }\n  const requestStub = {\n    params: ['addr', 'ji', 8]\n  }\n  // act\n  // Set a delay\n  configurationStub.getConfiguration.withArgs(configurationKeys.SUBSCRIPTION_EVENT_DELAY).returns(0)\n  const events = external.events(requestStub, proxy, { web3: web3Stub })\n  // assert\n  const startTime = Date.now()\n  events.subscribe(value => {\n    t.deepEqual(value, { event: 'pay_fee', amount: 5 })\n    // Hard to say exactly how much time this will take, but 20ms seems safe\n    // (this should be immediate)\n    t.true((Date.now() - startTime) < 20)\n  })\n\n  eventEmitter.emit('data', { event: 'pay_fee', amount: 5 })\n})\n\ntest('should apply a delay to events if configured', async (t) => {\n  const { external, configurationStub } = t.context\n  const delayTime = 1000\n\n  t.plan(2)\n  // arrange\n  const eventEmitter = new EventEmitter()\n  const proxy = {}\n  const contract = {\n    events: {\n      'allEvents': sinon.stub().returns(eventEmitter)\n    }\n  }\n  const web3Stub = {\n    eth: {\n      Contract: sinon.stub().returns(contract)\n    }\n  }\n  const requestStub = {\n    params: ['addr', 'ji', 8]\n  }\n  // act\n  // Set a delay\n  configurationStub.getConfiguration.withArgs(configurationKeys.SUBSCRIPTION_EVENT_DELAY).returns(delayTime)\n  const events = external.events(requestStub, proxy, { web3: web3Stub })\n  // assert\n  // Since we've added the delay, we need to tell ava to wait until we're done subscribing\n  return new Promise(resolve => {\n    const startTime = Date.now()\n    events.subscribe(value => {\n      t.deepEqual(value, { event: 'pay_fee', amount: 5 })\n      t.true((Date.now() - startTime) > delayTime)\n      resolve()\n    })\n\n    eventEmitter.emit('data', { event: 'pay_fee', amount: 5 })\n  })\n})\n"],"file":"external.test.js"}