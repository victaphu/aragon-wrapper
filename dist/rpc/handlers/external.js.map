{"version":3,"sources":["../../../src/rpc/handlers/external.js"],"names":["call","request","proxy","wrapper","web3","address","methodAbiFragment","params","contract","eth","Contract","methods","name","intent","transactionPath","getExternalTransactionPath","performTransactionPath","external","events","jsonInterface","eventNames","eventOptions","length","fromBlock","initializationBlock","eventSource","allEvents","pipe","event","includes","eventDelay","configurationKeys","SUBSCRIPTION_EVENT_DELAY","pastEvents","Promise","resolve","options","ranges","i","toBlock","push","res","range","arr","getPastEvents","concat","then","filter"],"mappings":"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","sourcesContent":["import { fromEvent, from } from 'rxjs'\nimport { delay, filter } from 'rxjs/operators'\nimport { getConfiguration } from '../../configuration'\nimport * as configurationKeys from '../../configuration/keys'\nimport { getEventNames } from '../../utils/events'\n\nexport function call (request, proxy, wrapper) {\n  const web3 = wrapper.web3\n  const [\n    address,\n    methodAbiFragment,\n    ...params\n  ] = request.params\n\n  const contract = new web3.eth.Contract(\n    [methodAbiFragment],\n    address\n  )\n\n  return contract.methods[methodAbiFragment.name](...params).call()\n}\n\nexport async function intent (request, proxy, wrapper) {\n  const [\n    address,\n    methodAbiFragment,\n    ...params\n  ] = request.params\n\n  const transactionPath = await wrapper.getExternalTransactionPath(\n    address,\n    methodAbiFragment,\n    params\n  )\n\n  return wrapper.performTransactionPath(transactionPath, { external: true })\n}\n\nexport function events (request, proxy, wrapper) {\n  const web3 = wrapper.web3\n  const [\n    address,\n    jsonInterface\n  ] = request.params\n\n  const contract = new web3.eth.Contract(\n    jsonInterface,\n    address\n  )\n\n  // `external_events` RPC compatibility with aragonAPI versions:\n  //   - aragonAPIv2: `'external_events', [address, jsonInterface, eventNames, eventOptions]`\n  //   - aragonAPIv1: `'external_events', [address, jsonInterface, fromBlock (optional)]`\n  let eventNames\n  let eventOptions\n  if (request.params.length === 4) {\n    // aragonAPIv2\n    eventNames = getEventNames(request.params[2])\n    eventOptions = request.params[3]\n  } else if (request.params.length <= 3) {\n    // aragonAPIv1\n    eventNames = ['allEvents']\n    eventOptions = { fromBlock: request.params[2] }\n  }\n  // Use the app proxy's initialization block by default\n  if (eventOptions.fromBlock == null) {\n    eventOptions.fromBlock = proxy.initializationBlock\n  }\n\n  let eventSource\n  if (eventNames.length === 1) {\n    // Get a specific event or all events unfiltered\n    eventSource = fromEvent(\n      contract.events[eventNames[0]](eventOptions),\n      'data'\n    )\n  } else {\n    // Get all events and filter ourselves\n    eventSource = fromEvent(\n      this.contract.events.allEvents(eventOptions),\n      'data'\n    ).pipe(\n      filter((event) => eventNames.includes(event.event))\n    )\n  }\n\n  const eventDelay = getConfiguration(configurationKeys.SUBSCRIPTION_EVENT_DELAY) || 0\n  // Small optimization: don't pipe a delay if we don't have to\n  return eventDelay ? eventSource.pipe(delay(eventDelay)) : eventSource\n}\n\nexport function pastEvents (request, proxy, wrapper) {\n  const web3 = wrapper.web3\n  const [\n    address,\n    jsonInterface\n  ] = request.params\n\n  const contract = new web3.eth.Contract(\n    jsonInterface,\n    address\n  )\n\n  // `external_past_events` RPC compatibility with aragonAPI versions:\n  //   - aragonAPIv2: `'external_past_events', [address, jsonInterface, eventNames, eventOptions]`\n  //   - aragonAPIv1: `'external_past_events', [address, jsonInterface, eventOptions]`\n  let eventNames\n  let eventOptions\n  if (request.params.length === 4) {\n    // aragonAPIv2\n    eventNames = getEventNames(request.params[2])\n    eventOptions = request.params[3]\n  } else if (request.params.length === 3) {\n    // aragonAPIv1\n    eventNames = ['allEvents']\n    eventOptions = request.params[2]\n  }\n  // Use the app proxy's initialization block by default\n  if (eventOptions.fromBlock == null) {\n    eventOptions.fromBlock = proxy.initializationBlock\n  }\n\n  // The `from`s only unpack the returned Promises (and not the array inside them!)\n  if (eventNames.length === 1) {\n    // Get a specific event or all events unfiltered\n    return from(\n      new Promise(async resolve => {\n          const options = eventOptions;\n          // console.log(\"Resolving \", resolve);\n          const ranges = [];\n\n          for (let i = +options.fromBlock; i < +options.toBlock; i += 1024) {\n            ranges.push({ ...options, fromBlock: i, toBlock: (i + 1023) > options.toBlock ? options.toBlock : i + 1023 });\n          }\n\n          // console.log(ranges);\n          // console.log(options);\n\n          let res = [];\n          for (let range of ranges) {\n            const arr = await contract.getPastEvents(eventNames[0], range);\n            if (arr && arr.length)\n              res = res.concat(arr);\n          }\n          // console.log(ranges, res);\n          resolve(res);\n        })\n    )\n  } else {\n    // Get all events and filter ourselves\n    return from(\n      contract.getPastEvents('allEvents', eventOptions)\n        .then(events => events.filter(event => eventNames.includes(event.event)))\n    )\n  }\n}\n"],"file":"external.js"}