{"version":3,"sources":["../../../src/rpc/handlers/external.js"],"names":["call","request","proxy","wrapper","web3","address","methodAbiFragment","params","contract","eth","Contract","methods","name","intent","transactionPath","getExternalTransactionPath","performTransactionPath","external","events","jsonInterface","eventNames","eventOptions","length","fromBlock","initializationBlock","eventSource","allEvents","pipe","event","includes","eventDelay","configurationKeys","SUBSCRIPTION_EVENT_DELAY","pastEvents","process","env","PAST_EVENTS_BATCH_SIZE","getPastEvents","options","eventName","then","filter"],"mappings":"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","sourcesContent":["import { fromEvent, from } from 'rxjs'\nimport { delay, filter } from 'rxjs/operators'\nimport { getConfiguration } from '../../configuration'\nimport * as configurationKeys from '../../configuration/keys'\nimport { getEventNames, getPastEventsByBatch } from '../../utils/events'\n\nexport function call(request, proxy, wrapper) {\n  const web3 = wrapper.web3\n  const [\n    address,\n    methodAbiFragment,\n    ...params\n  ] = request.params\n\n  const contract = new web3.eth.Contract(\n    [methodAbiFragment],\n    address\n  )\n\n  return contract.methods[methodAbiFragment.name](...params).call()\n}\n\nexport async function intent(request, proxy, wrapper) {\n  const [\n    address,\n    methodAbiFragment,\n    ...params\n  ] = request.params\n\n  const transactionPath = await wrapper.getExternalTransactionPath(\n    address,\n    methodAbiFragment,\n    params\n  )\n\n  return wrapper.performTransactionPath(transactionPath, { external: true })\n}\n\nexport function events(request, proxy, wrapper) {\n  const web3 = wrapper.web3\n  const [\n    address,\n    jsonInterface\n  ] = request.params\n\n  const contract = new web3.eth.Contract(\n    jsonInterface,\n    address\n  )\n\n  // `external_events` RPC compatibility with aragonAPI versions:\n  //   - aragonAPIv2: `'external_events', [address, jsonInterface, eventNames, eventOptions]`\n  //   - aragonAPIv1: `'external_events', [address, jsonInterface, fromBlock (optional)]`\n  let eventNames\n  let eventOptions\n  if (request.params.length === 4) {\n    // aragonAPIv2\n    eventNames = getEventNames(request.params[2])\n    eventOptions = request.params[3]\n  } else if (request.params.length <= 3) {\n    // aragonAPIv1\n    eventNames = ['allEvents']\n    eventOptions = { fromBlock: request.params[2] }\n  }\n  // Use the app proxy's initialization block by default\n  if (eventOptions.fromBlock == null) {\n    eventOptions.fromBlock = proxy.initializationBlock\n  }\n\n  let eventSource\n  if (eventNames.length === 1) {\n    // Get a specific event or all events unfiltered\n    eventSource = fromEvent(\n      contract.events[eventNames[0]](eventOptions),\n      'data'\n    )\n  } else {\n    // Get all events and filter ourselves\n    eventSource = fromEvent(\n      this.contract.events.allEvents(eventOptions),\n      'data'\n    ).pipe(\n      filter((event) => eventNames.includes(event.event))\n    )\n  }\n\n  const eventDelay = getConfiguration(configurationKeys.SUBSCRIPTION_EVENT_DELAY) || 0\n  // Small optimization: don't pipe a delay if we don't have to\n  return eventDelay ? eventSource.pipe(delay(eventDelay)) : eventSource\n}\n\nexport function pastEvents(request, proxy, wrapper) {\n  const web3 = wrapper.web3\n  const [\n    address,\n    jsonInterface\n  ] = request.params\n\n  const contract = new web3.eth.Contract(\n    jsonInterface,\n    address\n  )\n\n  // `external_past_events` RPC compatibility with aragonAPI versions:\n  //   - aragonAPIv2: `'external_past_events', [address, jsonInterface, eventNames, eventOptions]`\n  //   - aragonAPIv1: `'external_past_events', [address, jsonInterface, eventOptions]`\n  let eventNames\n  let eventOptions\n  if (request.params.length === 4) {\n    // aragonAPIv2\n    eventNames = getEventNames(request.params[2])\n    eventOptions = request.params[3]\n  } else if (request.params.length === 3) {\n    // aragonAPIv1\n    eventNames = ['allEvents']\n    eventOptions = request.params[2]\n  }\n  // Use the app proxy's initialization block by default\n  if (eventOptions.fromBlock == null) {\n    eventOptions.fromBlock = proxy.initializationBlock\n  }\n\n  // The `from`s only unpack the returned Promises (and not the array inside them!)\n  if (eventNames.length === 1) {\n    // Get a specific event or all events unfiltered\n    if (!process.env.PAST_EVENTS_BATCH_SIZE) {\n      return from(\n        contract.getPastEvents(eventNames[0], eventOptions)\n      )\n    }\n\n    return from(\n      getPastEventsByBatch({ options: eventOptions, contract: contract, eventName: eventNames[0] })\n    )\n  } else {\n    // Get all events and filter ourselves\n    return from(\n      contract.getPastEvents('allEvents', eventOptions)\n        .then(events => events.filter(event => eventNames.includes(event.event)))\n    )\n  }\n}\n"],"file":"external.js"}